\documentclass[11pt, oneside]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage[margin=2.25cm]{geometry}                		% See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex	
								
%\usepackage[T1]{fontenc}
%\usepackage[utf8]{inputenc}
%\usepackage{babel}
%\usepackage{csquotes}
									
\usepackage{amssymb}
\usepackage{lineno}
\linenumbers
\usepackage{setspace}
%\doublespacing
\usepackage{authblk}
\usepackage{hyperref}
\usepackage{xcolor}

%\usepackage{pythonhighlight}

\usepackage[utf8]{inputenc}

% Default fixed font does not support bold face
\DeclareFixedFont{\ttb}{T1}{txtt}{bx}{n}{10} % for bold
\DeclareFixedFont{\ttm}{T1}{txtt}{m}{n}{10}  % for normal

% Custom colors
\usepackage{color}
\definecolor{deepblue}{rgb}{0,0,0.5}
\definecolor{deepred}{rgb}{0.6,0,0}
\definecolor{deepgreen}{rgb}{0,0.5,0}

\usepackage{listings}

% Python style for highlighting
\newcommand\pythonstyle{\lstset{
language=Python,
basicstyle=\ttm,
morekeywords={self},              % Add keywords here
keywordstyle=\ttb\color{deepblue},
emph={MyClass,__init__},          % Custom highlighting
emphstyle=\ttb\color{deepred},    % Custom highlighting style
stringstyle=\color{deepgreen},
frame=none,                         % Any extra options here
showstringspaces=false,
numbers=none,
numbersep=5pt,
aboveskip=20pt,
belowskip=20pt,
xleftmargin=0.5cm,
}}

% Python environment
\lstnewenvironment{python}[1][]
{
\pythonstyle
\lstset{#1}
}
{}

% Python for external files
\newcommand\pythonexternal[2][]{{
\pythonstyle
\lstinputlisting[#1]{#2}}}

% Python for inline
\newcommand\pythoninline[1]{{\pythonstyle\lstinline!#1!}}


\usepackage{natbib}

\usepackage{lipsum}  

\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}

\author{Joseph D. Hughes}
\affil{U.S. Geological Survey, Model Support and Maintence Branch, 927 W Belle Plaine Ave, Chicago, IL, USA}
\author{Christian D. Langevin}
\affil{U.S. Geological Survey, Model Support and Maintence Branch, 2280 Woodale Dr, Mounds View, MN, USA}
\author{Scott R. Paulinski}
\affil{U.S. Geological Survey, California Water Science Center, 4165 Spruance Road, Suite 200, San Diego, CA, USA}
\author{Joshua D. Larsen}
\affil{U.S. Geological Survey, California Water Science Center, 6000 J Street, Placer Hall, Sacramento, CA, USA}
\author{David Brakenhoff}
\affil{Artesia Water, Korte Weistraat 12, Schoonhoven, Netherlands}


\begin{document}

\onecolumn

\title{Modern and Reproducible Groundwater Modeling Workflows with FloPy} 

\maketitle


\begin{abstract}

\noindent FloPy functionality has been expanded from the capabilities described in \cite{bakker2016scripting} to support the capabilities of the latest version of MODFLOW (MODFLOW 6). 

\end{abstract}

\section{Introduction}

FloPy is a popular Python package for constructing, running, and post processing MODFLOW-based groundwater flow and transport models \citep{bakker2016scripting}. It is an open-source Python package and continues to be developed with input from a growing community of modelers. Python is an interpreted, object-oriented programming language that has gained widespread popularity in science and engineering \citep{perez2010python}. Python is a high-level programming language, which means it has a more powerful syntax and a more complete set of data structures than low-level languages (Fortran or C, for example). In a high-level language, complex tasks can be achieved with a few lines of readable code. In addition to the core Python language, there is an extensive library of Python packages for just about any type of scientific analysis. Robust libraries are available for working with arrays \citep[Numpy;][]{2020NumPy-Array}, making publication-quality graphics \citep[Matplotlib;][]{hunter2007matplotlib}, optimization and statistics \cite[Scipy;][]{2020SciPy-NMeth}, working with geospatial information (Fiona; \citealp{fiona-gillies}, Shapely; \citealp{shapely-gillies}), and performing data analysis \citep[Pandas;][]{mckinney2011pandas}. These packages, together with the interactive IPython environment \citep{perez2007ipython} and Jupyter Notebooks \citep{Kluyver:2016aa}, form the core of what is called the Scipy Stack and are at the heart of exploratory computing with Python. Python itself, the Scipy Stack, and a long list of other packages are open-source software, and can be downloaded and used for free.

making use of open-source languages (such as R and Python) to write scripts and to use collaborative coding environments (such as Git) to share our codes for inspection and use by the hydrological community.

It has been recommended as one way to facilitate repeatable research and sharing of ideas \citep{fienen2016}

We have found FloPy to be particularly useful for teaching.  Annotated Jupyter notebooks, comparison with analytical solutions, ...

We rely on FloPy for MODFLOW development.  We write tests that rely on FloPy to construct and run models, and then read output.  We then verify that the output is as expected, by using the results from an analytical solution, results from another model, or results that have been confirmed to be correct.

We use FloPy to load models

 FloPy is used to pioneer new methods and analysis tools, such as deep learning approaches for improving groundwater model calibration \citep{sun2018, zhou2021}, regionalization of residence times using metamodeling \citep{starn2018}, iterative ensemble approaches for calibration and uncertainty quantification \citep{white2018ies}, and exploration of alternative parameterization schemes for risk analysis \citep{knowling2019}. There are numerous examples of constructing MODFLOW models to solve applied groundwater problems \citep{befus2017, vanengelen2018, ebeling2019, zipper2019, befus2020}.  Used in GIS-based tools, such as FREEWAT \citep{freewat2018} and other cyberinfrastructures \citep{essawy2018} to export models into MODFLOW datasets.  FloPy can also be used as the ``glue'' to help couple MODFLOW to other hydrological models \citep{burek2020} or even to agent-based models designed to quantify the effects of decision makers on environmental behavior \citep{jaxarozen2019}. 

\cite{bakker2016scripting} describe the general approach for working with models within the python environment and emphasize the reproducible nature of developing models through scripting.  FloPy has continued to advance since it was first described by \cite{bakker2016scripting}. The purpose of this paper is to highlight important advances, provide examples that demonstrate these new capabilities, and reinforce the advantages of the modern scripting workflow for developing reproducible groundwater models that can be easily updated as new data become available.  The important advances described here can be summarized as

\begin{itemize}
\item complete support for all models, packages, and options implemented in the core version of MODFLOW supported by the U.S. Geological Survey (MODFLOW 6),
\item generalized support for models based on a regular grid consisting of layers, rows, and columns, and also for models based on unstructured grids,
\item implementation of new geoprocessing capabilities to rapidly populate models with data from a variety of input sources, 
\item simplified access to model results, and
\item plotting capabilities for map and cross-section views of model data,
\item export capabilities for writing model data to a variety of output formats. 
\end{itemize}


\section{FloPy Support for MODFLOW 6}

The most recent version of MODFLOW (MODFLOW 6) is an object-oriented program and framework developed to provide a platform for supporting multiple models and multiple types of models within the same simulation \citep{modflow6gwf, modflow6framework, morway2021use}. These models can be independent of one another with no interaction, they can exchange coefficients and dependent variables (for example, head), or they can be tightly coupled at the matrix level by adding them to the same numerical solution. Transfer of information between models is isolated to exchange objects, which allow models to be developed and used independently. Within this new framework, a regional-scale groundwater model may be coupled with multiple local-scale groundwater models. 

MODFLOW 6 currently includes the Groundwater Flow (GWF) Model and the Groundwater Transport (GWT) Model each with packages to represent surface water processes,  groundwater extraction, external boundaries, mass sources and sinks, and mass sorption and reactions.  GWF and GWT models can be developed using regular model grids consisting of layers, rows, and columns or they can be developed using more general unstructured grids using many of the concepts and numerical approaches available in MODFLOW-USG  \citep{modflowusg}.  MODFLOW 6 also includes advanced formulations to simulate three-dimensional anisotropy and dispersion \citep{modflow6xt3d}, coupled variable-density groundwater flow and transport \citep{langevin2020hydraulic}, and a water mover package to represent natural and managed hydrologic connections \citep{morway2021use}.

Development and testing of the MODFLOW 6 program relies heavily on tight integration with FloPy.  A key component of this tight integration is the capability to quickly support new MODFLOW 6 models and packages with FloPy.  Unlike the FloPy support for previous MODFLOW versions (for example, MODFLOW-2005, MODFLOW-NWT, MODFLOW-USG, and SEAWAT), the FloPy python classes for MODFLOW 6 are dynamically generated from simple text files that describe the input file structure.  This allows MODFLOW 6 developers to write tests for new models, packages, and functionality as they are developed.  All MODFLOW 6 model input files are described using ``definition files.''  These definition files are used to generate the user input and output guide.  These same definition files are also used to generate FloPy classes, with argument docstrings corresponding to input variable descriptions in the input and output guide. Definition files used to create FloPy python classes for MODFLOW 6 are located in the \texttt{flopy/mf6/data/dfn/} subdirectory in the \texttt{site-packages} directory for your Python distribution or Python environment. The FloPy python classes for MODFLOW 6 can be regenerated using 

\begin{python}
>>> import flopy
>>> flopy.mf6.utils.createpackages.create_packages()
\end{python}

\noindent New functionality can be added by users to existing packages by modifying existing definition files using the instructions provided in the \href{https://github.com/MODFLOW-USGS/modflow6/tree/develop/doc/mf6io/mf6ivar}{MODFLOW 6 GitHub repository}. The existing definition files can also be used as a template for creating classes for new MODFLOW 6 models or packages. New definition files should be placed in the \texttt{flopy/mf6/data/dfn/} subdirectory prior to rerunning \pythoninline{flopy.mf6.utils.createpackages.create_packages()}.

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/mf6definition.pdf}
	\end{center}
	\caption{Relation between MODFLOW 6 input description files and the MODFLOW 6 input and output guide and the FloPy Python classes for MODFLOW 6.}
	\label{fig:mf6definition}
\end{figure}

\section{Common Modeling Tasks}

\subsection{Generating Grids}

Spatial discretization of a model domain into a model grid is a fundamental step in constructing a groundwater model.  FloPy continues to support regular MODFLOW grids, which are defined by layers, rows, and columns.  Regular MODFLOW grids can have constant row and column spacings, as shown in Figure \ref{fig:grids}A, or they can have variable row and column spacings to focus resolution around an area of interest, as shown in Figure \ref{fig:grids}B.  FloPy internally represents this type of grid as a \texttt{StructuredGrid} object, which is automatically created from discretization data required when instantiating a MODFLOW 6 \texttt{DIS} object using \texttt{flopy.mf6.ModflowGwfdis()}.  

\begin{python}
>>> regular_grid = StructuredGrid(nlay=nlay, delr=delr, delc=delc,  
... xoff=0.0, yoff=0.0, top=top, botm=botm)
\end{python}

MODFLOW 6 was developed to natively support multi-model simulations \citep{modflow6framework}. One form of multi-model simulation is a nested grid application in which a more finely discretized child model is embedded within a more coarsely discretized parent model \citep{modflowlgr, vilhelmsen2012evaluation, modflowlgr2}.  The use of a locally refined grid (LGR) within a parent grid offers computation benefits in that the additional refinement is targeted to an area of interest.  FloPy provides a utility class, called \texttt{flopy.utils.lgrutil.Lgr()} for constructing the data required to tightly couple parent and child models within a single MODFLOW 6 simulation.   Figure \ref{fig:grids}C shows a nested child model within a parent model.  The \texttt{flopy.utils.lgrutil.Lgr()} defines the connection properties between cells in the parent model and cells in the child model.  The utility is general in that the child model can have more layers than the parent model.

Support for unstructured grid types has been a recent focus of MODFLOW development \citep{modflowusg, modflow6gwf, modflow6xt3d}.  FloPy supports generation of several types of unstructured grids, including layered quadtree grids.  A layered quadtree grid can be created with FloPy using the \texttt{flopy.utils.gridgen.Gridgen()} utility class, which is a wrapper around the GRIDGEN program \citep{gridgen}.  GRIDGEN works by starting with a regular MODFLOW grid and recursively subdividing individual cells into quarters until a maximum level of refinement is met.  Smoothing is automatically handled so that a cell is connected to no more than two cells in any horizontal direction and four cells in the vertical direction.   Figure \ref{fig:grids}D shows an example of a quadtree grid created with GRIDGEN in which a base grid is refined along streams.

\begin{python}
>>> sim = flopy.mf6.MFSimulation()
>>> gwf = flopy.mf6.ModflowGwf(sim)
>>> dis6 = flopy.mf6.ModflowGwfdis(gwf, nrow=nrow, ncol=ncol, delr=dy, delc=dx)
>>> g = Gridgen(dis6, model_ws=temp_path)
>>> g.add_refinement_features([[closed_polygon]], "polygon", 0, range(1))
>>> g.add_refinement_features(stream_points, "line", 2, range(1))
>>> g.build(verbose=False)
>>> gridprops_vg = g.get_gridprops_vertexgrid()
>>> quadtree_grid = flopy.discretization.VertexGrid(**gridprops_vg)
\end{python}

FloPy also provides a wrapper utility for the Triangle \citep{trianglemesh} program.  The FloPy wrapper utility (\texttt{flopy.utils.triangle.Triangle()}) writes the Triangle program input file, runs the Triangle program, and then loads the triangular mesh.  Users provide the maximum area for individual triangles, angle constraints, a polygon describing the model domain, and so forth.  Figure \ref{fig:grids}E shows an example of a triangular grid created with the Triangle program.

\begin{python}
>>> tri = Triangle(maximum_area=maximum_area, angle=30, nodes=nodes, 
... model_ws=temp_path)
...
>>> tri.add_polygon(boundary_points)
>>> tri.build(verbose=False)
>>> cell2d = tri.get_cell2d()
>>> vertices = tri.get_vertices()
>>> triangular_grid = VertexGrid(vertices=vertices, cell2d=cell2d, 
... idomain=idomain, nlay=nlay, ncpl=tri.ncpl, top=top, botm=botm)
...
\end{python}

A triangular grid can be converted into a Voronoi grid within FloPy using the \texttt{flopy.utils.voronoi.VoronoiGrid()} utility class.  This utility class uses SciPy methods  \citep{2020SciPy-NMeth} to construct Voronoi polygons around each vertex in the triangular mesh.  Figure \ref{fig:grids}F shows an example of a Voronoi grid created created from the triangular mesh shown in D.

\begin{python}
>>> vor = VoronoiGrid(tri)
>>> gridprops = vor.get_gridprops_vertexgrid()
>>> voronoi_grid = VertexGrid(**gridprops, nlay=nlay, idomain=idomain)
\end{python}

FloPy gridding allows for innovation; mention Central Sands and the ability to simulate local-scale detail and regional-scale influence in the same simulation?

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/grids_geoprocessing.png}
	\end{center}
	\caption{Examples of grids that can be generated and processed using FloPy for a hypothetical watershed, including (A) a regular MODFLOW grid with constant and equal row and column spacings, (B) a regular MODFLOW grid with variable row and column spacings, (C) a regular MODFLOW child grid nested within a regular MODFLOW parent grid, (D) a quadtree grid generated with the GRIDGEN program \citep{gridgen} through the FloPy wrapper, (D) a triangular grid generated with the Triangle program \citep{trianglemesh} through the FloPy wrapper, and (E) a Voronoi grid created from the triangular mesh.}\label{fig:grids}
\end{figure}

Talk about useful methods available on the grid objects...

\subsection{Geospatial Processing}

Geospatial processing functionality has been added to FloPy to allow users to easily evaluate different grid resolutions or grid types. Raster resampling is available for \texttt{StructuredGrid} and \texttt{VertexGrid} objects. Examples of   

Raster resampling, ...

\begin{python}
>>> fine_topo = flopy.utils.Raster.load("./grid_data/fine_topo.asc")
>>> top_vg = fine_topo.resample_to_grid(voronoi_grid, band=fine_topo.bands[0],
... method="linear", extrapolate_edges=True)
...
\end{python}

%\lipsum[103]

Intersections ...

\begin{python}
>>> ixs = flopy.utils.GridIntersect(voronoi_grid, method="vertex")
>>> cellids = []
>>> for points in segments:
...     segment = ixs.intersect(LineString(points), sort_by_cellid=True)
...     cellids += segment["cellids"].tolist()
...
\end{python}

%\lipsum[103-105]


\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/grids_intersection.png}
	\end{center}
	\caption{Examples of the intersection of a linear stream network and MODFLOW grids shown in figure~\ref{fig:grids} using FloPy, including (A) a regular structured MODFLOW grid, (B) a structured MODFLOW grid with irregular spacing, (C) a regular MODFLOW child grid nested within a regular MODFLOW parent grid, (D) a quadtree grid, (D) a triangular grid, and (E) a voronoi grid. The shaded cells represent cells that intersect the river network. The plots are centered on the location of the child grid shown in figure~\ref{fig:grids}C.}
	\label{fig:intersections}
\end{figure}

%\lipsum[106-108]


\subsection{Processing MODFLOW 6 output}

Available output methods 


\begin{python}
>>> gwf.output.methods()
['list()', 'zonebudget()', 'budget()', 'budgetcsv()', 'head()']
\end{python}

Processing head output 

\begin{python}
>>> head = gwf.output.head().get_data(totim=1.0)
\end{python}

Processing cell-by-cell output 

\begin{python}
>>> cbc = gwf.output.budget()
>>> cbc.list_unique_records()
RECORD           IMETH
----------------------
FLOW-JA-FACE         1
DATA-SPDIS           6
DRN                  6
RCHA                 6
\end{python}

Specific discharge

\begin{python}
>>> spdis = cbc.get_data(text="DATA-SPDIS")[0]
>>> qx, qy, qz = flopy.utils.postprocessing.get_specific_discharge(spdis, gwf)
\end{python}

\subsection{Plotting}

Processing output

Maps

\begin{python}
>>> mm = flopy.plot.PlotMapView(model=gwf)
>>> cb = mm.plot_array(head, edgecolor="0.5")
>>> mm.plot_bc("CHD")
>>> mm.plot_vector(qx_top, qy_top, normalize=True)
>>> plt.colorbar(cb, orientation="horizontal");
>>> plt.show()
\end{python}

Cross-sections 

\begin{python}
>>> fx = flopy.plot.PlotCrossSection(model=gwf, 
... line={"line": [(0, 42500), (186801, 42500)]})
...
>>> fx.plot_array(head, head=head)
>>> fx.plot_grid()
>>> plt.show()
\end{python}

%\lipsum[54]

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/grids_flopy_plots.png}
	\end{center}
	\caption{FloPy plotting.}
	\label{fig:flopyplots}
\end{figure}

%\lipsum[2-4]

\subsection{Exporting Grid Data to Other Formats}

Model input and output can be exported in a variety of standard formats using the \texttt{export()} method, which is available for FloPy model objects, package objects, and binary dependent-variable (head, concentration, \textit{etc.}) and cell-by-cell output files. Standard output formats that are currently supported include shapefiles \citep{environmental1998esri}, NetCDF files \citep{rew2006netcdf, rew1990netcdf}, and Visualization Tool Kit (VTK) files \citep{schroeder:2006:VTK}.

shapefiles (all grids), VTK (all grids) and NetCDF (structured grids).  NetCDF files are being used, for example, by the GWWebFlow viewer?  

\begin{python}
>>> gwf.export("temp_vtk/vtk_smooth", fmt='vtk', smooth=True,
... vertical_exageration=500.0, pvd=True)
...
\end{python}

%\lipsum[2-6]

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/mf6vtk.pdf}
	\end{center}
	\caption{FloPy export.}
	\label{fig:flopyvtk}
\end{figure}

%\lipsum[2-4]

\section{Example}

Background of the McDonald Valley \citep{hill1998}

%\lipsum[12-18]

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/mv_voronoi_river_discretization.png}
	\end{center}
	\caption{McDonald Valley grid intersections.}
	\label{fig:mvgrid}
\end{figure}

%\lipsum[2-4]

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/mv_voronoi_map.png}
	\end{center}
	\caption{McDonald Valley topography and head.}
	\label{fig:mvmap}
\end{figure}

%\lipsum[2-4]

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/mv_voronoi_xsection.png}
	\end{center}
	\caption{McDonald Valley topography and head.}
	\label{fig:mvxsection}
\end{figure}

%\lipsum[2-4]

\begin{figure}[ht!]
	\begin{center}
		\includegraphics{figures/mv_voronoi_map_concentration.png}
	\end{center}
	\caption{McDonald Valley concentrations.}
	\label{fig:mvxsection}
\end{figure}

%\lipsum[2-4]

\section{Summary and Conclusions}
FloPy is a popular Python package for building, running, and post processing groundwater models.  It is open source and developed with input from a growing community of modelers.  This paper summarizes important new FloPy capabilities that have been added since the package was first described by \citep{bakker2016scripting}.  The new capabilities can be summarized as follows.

\begin{itemize}
\item FloPy supports the creation of many different types of groundwater models, including models that use MODFLOW 6, MODFLOW-2005, MODFLOW-NWT, MODFLOW-USG, MT3D, MT3D-USGS, and SEAWAT.  FloPy support for MODFLOW 6 is based on an entirely new approach designed to automatically support all MODFLOW 6 models, packages, and options.  The underlying FloPy classes for MODFLOW 6 are programmatically generated from the same input definition files that are used to construct the MODFLOW 6 user guide.  This correspondence ensures that the FloPy classes are in direct correspondence with MODFLOW 6 input.
\item FloPy has been extended to support unstructured model grids in addition to regular grids defined by layers, rows, and columns.  FloPy has several different routines for creating unstructured grids.  FloPy has a wrapper routine around the GRIDGEN program \citep{gridgen}, which can be used to create layered quadtree grids.  FloPy also has a wrapper around the Triangle program \citep{trianglemesh}, which can be used to create triangular meshes.  A triangular mesh can be converted by FloPy into a Voronoi grid.  Grid information is stored for each FloPy model created by the user.  This model grid object is used systemically throughout FloPy for geospatial operations, plotting, and exporting model information to supported formats.
\item Geospatial intersections of points, lines, and polygons with model grids and raster resampling onto model grids are common steps in model construction.  FloPy fully supports these geospatial operations through its grid intersection and raster resampling routines.
\item Access to model output using FloPy has been simplified for MODFLOW 6 models.  
\item Map and cross section plotting
\item Export to shapefiles, VTK, and NetCDF
\end{itemize}

FloPy makes it possible to construct, and reproduce the construction, of a groundwater model from native data in any format that can be accessed using Python.  The robust new features in FloPy allow users to quickly try different model grids, different model spatial and temporal resolution, and different model configurations.  

\section*{Acknowledgments}
This is a short text to acknowledge the contributions of specific colleagues, institutions, or agencies that aided the efforts of the authors.

\section*{Supplemental Data}
 \href{http://home.frontiersin.org/about/author-guidelines#SupplementaryMaterial}{Supplementary Material} should be uploaded separately on submission, if there are Supplementary Figures, please include the caption in the same file as the figure. LaTeX Supplementary Material templates can be found in the Frontiers LaTeX folder.

\section*{Data Availability Statement}
The datasets [h]GENERATED/ANALYZED] for this study can be found in the [NAME OF REPOSITORY] [LINK].
% Please see the availability of data guidelines for more information, at https://www.frontiersin.org/about/author-guidelines#AvailabilityofData

\bibliographystyle{groundwater}
\bibliography{flopy}

\end{document}
